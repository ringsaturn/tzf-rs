name: Rust

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write
  deployments: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PROTOC_VERSION: "3.20.3"
    steps:
      - name: Collect Workflow Telemetry
        uses: runforesight/workflow-telemetry-action@v1
      - uses: actions/checkout@v3
      - name: Setup | Rust
        uses: ATiltedTree/setup-rust@v1
        with:
          rust-version: nightly
      - name: Install protoc
        run: |
          curl -OL https://github.com/protocolbuffers/protobuf/releases/download/v$PROTOC_VERSION/protoc-$PROTOC_VERSION-linux-x86_64.zip
          sudo unzip -o protoc-$PROTOC_VERSION-linux-x86_64.zip -d /usr/local bin/protoc
          sudo unzip -o protoc-$PROTOC_VERSION-linux-x86_64.zip -d /usr/local 'include/*'
          rm -f protoc-$PROTOC_VERSION-linux-x86_64.zip
      - name: Cache
        uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test --verbose
      - name: Run benches
        run: cargo bench
      # - name: Continuous Benchmark
      #   uses: benchmark-action/github-action-benchmark@v1.15.0
      #   if: ${{ github.ref == 'refs/heads/main' }}
      #   with:
      #     name: Go Benchmark
      #     tool: "cargo"
      #     output-file-path: output.txt
      #     github-token: ${{ secrets.CI_TOKEN }}
      #     gh-repository: "github.com/ringsaturn/tzf-rs"
      #     auto-push: true
      #     comment-on-alert: true
      #     fail-on-alert: false
      #     benchmark-data-dir-path: "docs/"
